{% extends "layout.html" %}

{% block title %}{{ filepath }}{% endblock %}

{% block content %}
<div class="file-breadcrumb-container">
    <i class="fas fa-folder" style="color: var(--color-fg-muted);"></i>
    <a href="{{ url_for('view_tree', repo_name=repo_name, ref=ref) }}" class="breadcrumb-root">{{
        repo_name }}</a>
    <span class="breadcrumb-separator">/</span>
    {% set parts = filepath.split('/') %}
    {% set ns = namespace(path='') %}
    {% for part in parts[:-1] %}
    {% set ns.path = ns.path + part + '/' %}
    <a href="{{ url_for('view_tree', repo_name=repo_name, ref=ref, subpath=ns.path.rstrip('/')) }}"
        class="breadcrumb-item">{{ part }}</a>
    <span class="breadcrumb-separator">/</span>
    {% endfor %}
    <span class="breadcrumb-leaf">{{ parts[-1] }}</span>
</div>

<div class="Box">
    <div class="Box-header file-view-header">
        <div class="file-view-info">
            <i class="far fa-file-code"></i>
            <span>{{ filepath.split('/')[-1] }}</span>
            <span class="file-ref-label">({{ display_ref }})</span>
        </div>
        <div class="file-view-actions">
            <div class="file-meta">
                {% if file_size %}
                <span>{{ file_size }}</span>
                {% endif %}
            </div>
            <a href="{{ url_for('view_file', repo_name=repo_name, ref=ref, filepath=filepath) }}?raw=1"
                class="btn btn-sm" target="_blank">
                原始数据
            </a>
        </div>
    </div>

    {% if is_image %}
    <div style="background: var(--color-canvas-subtle); padding: 32px; text-align: center;">
        <img src="{{ url_for('view_file', repo_name=repo_name, ref=ref, filepath=filepath) }}?raw=1"
            style="max-width: 100%; border-radius: 6px; box-shadow: 0 3px 12px rgba(0,0,0,0.3);" alt="{{ filepath }}">
    </div>
    {% elif is_video %}
    <div style="background: var(--color-canvas-subtle); padding: 32px; text-align: center;">
        <video controls style="max-width: 100%; border-radius: 6px; box-shadow: 0 3px 12px rgba(0,0,0,0.3);">
            <source src="{{ url_for('view_file', repo_name=repo_name, filepath=filepath) }}?raw=1">
            您的浏览器不支持 video 标签。
        </video>
    </div>
    {% elif is_pdf %}
    <div style="background: var(--color-canvas-subtle); padding: 16px;">
        <iframe src="{{ url_for('view_file', repo_name=repo_name, filepath=filepath) }}?raw=1"
            style="width: 100%; height: 800px; border: none; border-radius: 6px;">
        </iframe>
    </div>
    {% elif is_markdown %}
    <div class="markdown-body" id="markdown-content" style="border: none; padding: 32px; border-radius: 0;">

    </div>
    <script src="https://cdn.jsdelivr.net/npm/marked/lib/marked.umd.js"></script>
    <script>
        window.MathJax = {
            tex: {
                inlineMath: [['$', '$'], ['\\(', '\\)']],
                displayMath: [['$$', '$$'], ['\\[', '\\]']],
                processEscapes: true,
                processEnvironments: true
            },
            options: {
                skipHtmlTags: ['script', 'noscript', 'style', 'textarea', 'pre']
            }
        };
    </script>
    <script id="MathJax-script" async src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
    <script>
        const markdownText = {{ content| tojson }};
        const repoName = {{ repo_name| tojson }};
        const gitRef = {{ ref| tojson }};
        const currentFilepath = {{ filepath| tojson }};


        function escapeHtml(text) {
            return text
                .replace(/&/g, "&amp;")
                .replace(/</g, "&lt;")
                .replace(/>/g, "&gt;")
                .replace(/"/g, "&quot;")
                .replace(/'/g, "&#039;");
        }


        const mathExpressions = [];

        function extractMath(text) {

            text = text.replace(/\$\$([\s\S]*?)\$\$/g, function (match) {
                const id = mathExpressions.length;
                mathExpressions.push(match);
                return ' MATHBLOCKPLACEHOLDER' + id + ' ';
            });


            text = text.replace(/\$((?:[^$\\]|\\.)+)\$/g, function (match) {
                const id = mathExpressions.length;
                mathExpressions.push(match);
                return ' MATHINLINEPLACEHOLDER' + id + ' ';
            });

            return text;
        }

        function restoreMath(html) {
            return html.replace(/MATH(BLOCK|INLINE)PLACEHOLDER(\d+)/g, function (match, type, id) {
                return escapeHtml(mathExpressions[parseInt(id)]);
            });
        }


        let finalHtml = '';
        if (typeof marked !== 'undefined') {
            try {
                const textWithPlaceholders = extractMath(markdownText);
                const rawHtml = marked.parse(textWithPlaceholders);
                finalHtml = restoreMath(rawHtml);
            } catch (e) {
                console.error('Markdown parsing error:', e);
                finalHtml = '<p style="color:red">Error rendering markdown</p><pre>' + escapeHtml(markdownText) + '</pre>';
            }
        } else {
            console.warn('Marked library not loaded');
            finalHtml = '<pre>' + escapeHtml(markdownText) + '</pre>';
        }


        const contentDiv = document.getElementById('markdown-content');
        contentDiv.innerHTML = finalHtml;


        const currentDir = currentFilepath.split('/').slice(0, -1).join('/');

        function resolveRelativePath(relativePath) {
            if (relativePath.startsWith('http://') ||
                relativePath.startsWith('https://') ||
                relativePath.startsWith('//') ||
                relativePath.startsWith('/')) {
                return relativePath;
            }

            let basePath = currentDir ? currentDir.split('/') : [];
            let parts = relativePath.split('/');

            for (let part of parts) {
                if (part === '..') {
                    basePath.pop();
                } else if (part !== '.' && part !== '') {
                    basePath.push(part);
                }
            }
            return basePath.join('/');
        }


        const images = document.querySelectorAll('#markdown-content img');
        images.forEach(img => {
            const src = img.getAttribute('src');
            if (src && !src.startsWith('http://') && !src.startsWith('https://') && !src.startsWith('//')) {
                const resolvedPath = resolveRelativePath(src);
                img.src = `/${repoName}/blob/${gitRef}/${resolvedPath}?raw=1`;
            }
        });


        const links = document.querySelectorAll('#markdown-content a');
        links.forEach(link => {
            const href = link.getAttribute('href');
            if (href && !href.startsWith('http://') && !href.startsWith('https://') && !href.startsWith('//') && !href.startsWith('#')) {
                const resolvedPath = resolveRelativePath(href);
                const ext = resolvedPath.split('.').pop().toLowerCase();
                const isLikelyFile = ['md', 'txt', 'pdf', 'doc', 'docx', 'jpg', 'png', 'gif', 'svg', 'html', 'css', 'js', 'py', 'java', 'cpp', 'c', 'h'].includes(ext);

                if (isLikelyFile) {
                    link.href = `/${repoName}/blob/${gitRef}/${resolvedPath}`;
                } else {
                    link.href = `/${repoName}/tree/${gitRef}/${resolvedPath}`;
                }
            }
        });


        if (window.MathJax && window.MathJax.typesetPromise) {
            MathJax.typesetPromise([contentDiv]).catch((err) => console.log('MathJax error:', err));
        }
    </script>
    {% elif is_binary %}
    <div style="padding: 32px; text-align: center; color: var(--color-fg-muted);">
        <i class="fas fa-file-code" style="font-size: 48px; margin-bottom: 16px; display: block;"></i>
        <p>这是一个二进制文件，无法显示。</p>
        <a href="{{ url_for('view_file', repo_name=repo_name, filepath=filepath) }}?raw=1" class="btn btn-primary"
            download>
            <i class="fas fa-download"></i> 下载文件
        </a>
    </div>
    {% else %}
    <div style="background-color: var(--color-canvas-subtle); overflow-x: auto; padding: 0;">
        <table class="diff-table">
            {% for line in content.splitlines() %}
            <tr>
                <td class="blob-num">{{ (current_page - 1) * per_page + loop.index }}</td>
                <td class="blob-code">{{ line }}</td>
            </tr>
            {% endfor %}
        </table>
    </div>
    {% endif %}

    {% if total_pages > 1 %}
    <div style="text-align: center; margin-top: 16px; margin-bottom: 16px;">
        <div class="BtnGroup">
            {% if current_page > 1 %}
            <a href="{{ url_for('view_file', repo_name=repo_name, ref=ref, filepath=filepath, page=current_page-1) }}"
                class="btn BtnGroup-item" style="border-radius: 6px 0 0 6px;">上一页</a>
            {% else %}
            <button class="btn BtnGroup-item" disabled style="border-radius: 6px 0 0 6px;">上一页</button>
            {% endif %}

            <button class="btn BtnGroup-item" disabled>第 {{ current_page }} / {{ total_pages }} 页</button>

            {% if current_page < total_pages %} <a
                href="{{ url_for('view_file', repo_name=repo_name, ref=ref, filepath=filepath, page=current_page+1) }}"
                class="btn BtnGroup-item" style="border-radius: 0 6px 6px 0;">下一页</a>
                {% else %}
                <button class="btn BtnGroup-item" disabled style="border-radius: 0 6px 6px 0;">下一页</button>
                {% endif %}
        </div>
    </div>
    {% endif %}
</div>
{% endblock %}